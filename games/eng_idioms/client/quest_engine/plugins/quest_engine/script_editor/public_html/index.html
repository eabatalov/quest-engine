<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html class="html">
    <head>
        <title>Quest script editor</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
        }
        </style>
        <link rel="stylesheet" type="text/css" href="style/index.css" id="pagesheet"/>
        <script src="js/libs/jquery/jquery.js"></script>
        <script src="js/angular.js"></script>
        <script src="js/libs/pixi.js-1.5.1/bin/pixi.dev.js"></script>
        <script src="js/quest_engine/quest_scripting.js"></script>
        <script src="js/objects.js"></script>
        <script src="js/common.js"></script>
        <script src="js/toolbar.js"></script>
        <script src="js/props.js"></script>
        <script src="js/script.js"></script>
        <script src="js/script_editor.js"></script>
    </head>
    <body ng-app="ScriptEditorApp" ng-controller="ScriptEditorController">
        <canvas id="toolbarAndTreeCanvas" style="position: absolute; height: 100%;">
        </canvas>
        <div class="win8" style="position: absolute;" id="propsDiv"
            ng-controller="ScriptEditorPropertiesWindowController">

            <div ng-show="cond !== null">

                <div>
                    <label for="id">Condition type</label>
                    <div>
                        <select ng-model="cond.type" ng-change="condTypeChanged()"
                            ng-options="type.id as type.title for type in condTypes"></select>
                    </div>
                </div>

                <div ng-show="cond.priv.id | hasFieldValue">
                    <label for="id">Object</label>
                    <div>
                        <select ng-model="cond.priv.id"
                            ng-options="obj for obj in scriptEditor.nodes.stages[0].priv.objs"></select>
                    </div>
                </div>
            </div>

            <div ng-show="node !== null">
                <div ng-show="node.priv.name | hasFieldValue">
                    <label for="name">Name</label>
                    <div>
                        <input type="text" name="name" ng-model="node.priv.name" placeholder="Name" autofocus/>
                    </div>
                </div>

                <div ng-show="node.priv.id | hasFieldValue">
                    <label for="id">Object</label>
                    <div>
                        <select ng-model="node.priv.id"
                            ng-options="obj for obj in scriptEditor.nodes.stages[0].priv.objs"></select>
                    </div>
                </div>

                <div ng-show="node.priv.secs  | hasFieldValue">
                    <label for="secs">Seconds</label>
                    <div>
                        <input type="text" name="secs" ng-model="node.priv.secs" placeholder="Seconds" autofocus/>
                    </div>
                </div>

                <div ng-show="node.priv.text  | hasFieldValue">
                    <label for="text">Text</label>
                    <div>
                        <input type="text" name="text" ng-model="node.priv.text" placeholder="Text" autofocus/>
                    </div>
                </div>

                <div ng-show="node.priv.ans1  | hasFieldValue">
                    <label for="ans1">Answer 1</label>
                    <div>
                        <input type="text" name="ans1" ng-model="node.priv.ans1" placeholder="Answer 1" autofocus/>
                    </div>
                </div>

                <div ng-show="node.priv.ans2  | hasFieldValue">
                    <label for="ans2">Answer 2</label>
                    <div>
                        <input type="text" name="ans2" ng-model="node.priv.ans2" placeholder="Answer 2" autofocus/>
                    </div>
                </div>

                <div ng-show="node.priv.ans3  | hasFieldValue">
                    <label for="ans3">Answer 3</label>
                    <div>
                        <input type="text" name="ans3" ng-model="node.priv.ans3" placeholder="Answer 3" autofocus/>
                    </div>
                </div>

                <div ng-show="node.priv.ans4  | hasFieldValue">
                    <label for="ans4">Answer 4</label>
                    <div>
                        <input type="text" name="ans4" ng-model="node.priv.ans4" placeholder="Answer 4" autofocus/>
                    </div>
                </div>

                <div ng-show="node.type === _QUEST_NODE_STORYLINE">
                    <label>Objects</label>
                    <div>
                        <select ng-model="objToAdd"
                            ng-options="obj for obj in scriptEditor.nodes.stages[0].priv.objPool"></select>
                        <button ng-click="addObjectToStoryLine()">
                            Add to story line
                        </button>
                        <ul>
                            <li ng-repeat="obj in node.priv.objs">
                                {{ obj }}
                            </li>
                        </ul>
                    </div>
                </div>

                <div ng-show="node.type === _QUEST_NODE_STAGE">
                    <label>Objects</label>
                    <div>
                        <input type="text" ng-model="objToAdd" placeholder="Object to add"
                            required ng-maxlength="50"/>
                        <button ng-click="addObjectToStage()">
                            Add to stage
                        </button>
                        <ul>
                            <li ng-repeat="obj in scriptEditor.nodes.stages[0].priv.objs">
                                {{ obj }}
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>

        <script type="text/javascript">
            scriptEditorApp = angular.module('ScriptEditorApp', []);
            scriptEditorApp.config(function() {
                Array.prototype.remove = function() {
                    var what, a = arguments, L = a.length, ax;
                    while (L && this.length) {
                        what = a[--L];
                        while ((ax = this.indexOf(what)) !== -1) {
                            this.splice(ax, 1);
                        }
                    }
                    return this;
                };
            });

            scriptEditorApp.filter('hasFieldValue', function() {
                return function(value) {
                    if (value !== null && value !== undefined) {
                            return true
                        } else
                            return false;
                };
            });

            scriptEditorApp.factory('ScriptEditorEvents',
                function($rootScope) {
                    var events = {};

                    events.args = {
                        name : "",
                        obj : null,
                    };

                    events.broadcast = function(args) {
                        this.args = args;
                        $rootScope.$broadcast('seEvent');
                    };

                    return events;
                });

            scriptEditorApp.controller('ScriptEditorController',
                ['$scope', 'ScriptEditorEvents',
                function($scope, seEvents) {
                    $scope.scriptEditor = new ScriptEditor();
                    $scope._QUEST_NODE_STAGE = _QUEST_NODE_STAGE;
                    $scope._QUEST_NODE_STORYLINE = _QUEST_NODE_STORYLINE;
                }
            ]);

            scriptEditorApp.controller('ScriptEditorPropertiesWindowController',
                ['$scope', 'ScriptEditorEvents',
                function($scope, seEvents) {
                    $scope.condTypes = [
                        { id: _QUEST_COND_NONE, title: 'None'},
                        { id: _QUEST_COND_OBJECT_CLICKED, title: 'Object clicked'},
                        { id: _QUEST_COND_ANSWER_1_CLICKED, title: 'Answer 1 clicked'},
                        { id: _QUEST_COND_ANSWER_2_CLICKED, title: 'Answer 2 clicked'},
                        { id: _QUEST_COND_ANSWER_3_CLICKED, title: 'Answer 3 clicked'},
                        { id: _QUEST_COND_ANSWER_4_CLICKED, title: 'Answer 4 clicked'},
                        { id: _QUEST_COND_ANSWER_OTHER_CLICKED, title: 'Answer other clicked'},
                        { id: _QUEST_COND_CONTINUE, title: 'Continue'},
                        { id: _QUEST_COND_DEFAULT, title: 'Default'}
                    ];
                    $scope.objToAdd = null;
                    $scope.seEvents = seEvents;
                    $scope.node = null;
                    $scope.cond = null;

                    $scope.$on('seEvent', function() {
                        if (seEvents.args.name === "NODE_PROP_EDIT") {
                            $scope.setPropsObject(seEvents.args.obj, true);
                        } else if (seEvents.args.name === "COND_PROP_EDIT") {
                            $scope.setPropsObject(seEvents.args.obj, false);
                        } else if (seEvents.args.name === "NODE_CREATE") {
                            var scriptAreaGlobalXY = new PIXI.Point(0, 0);
                            scriptAreaGlobalXY.x =
                                $scope.scriptEditor.layers.script.position.x;
                            scriptAreaGlobalXY.y =
                                $scope.scriptEditor.layers.script.position.y;
                            var newNodePoint = new PIXI.Point(
                                seEvents.args.targetPointGlobal.x - scriptAreaGlobalXY.x,
                                seEvents.args.targetPointGlobal.y - scriptAreaGlobalXY.y
                            );
                            if (newNodePoint. x < 0 || newNodePoint.y < 0) {
                                return;
                            }
                            var newNode = new SENode(seEvents.args.type);
                            newNode.position = newNodePoint;
                            $scope.scriptEditor.layers.script.addChild(newNode);
                            $scope.scriptEditor.nodes.all.push(newNode);
                            $scope.setPropsObject(newNode, true);
                            $scope.scriptEditor.updateStage();
                        }
                    });

                    $scope.addObjectToStoryLine = function() {
                        $scope.node.priv.objs.push($scope.objToAdd);
                        $scope.scriptEditor.nodes.stages[0].priv.objPool.remove($scope.objToAdd);
                    }

                    $scope.addObjectToStage = function() {
                        $scope.node.priv.objs.push($scope.objToAdd);
                        $scope.node.priv.objPool.push($scope.objToAdd);
                    }

                    $scope.setPropsObject = function(obj, isNode) {
                        if (isNode) {
                            $scope.node = obj;
                            $scope.cond = null;
                        } else {
                            $scope.node = null;
                            $scope.cond = obj;                            
                        }
                        $scope.$digest();
                    }

                    $scope.condTypeChanged = function() {
                        $scope.cond.changeType($scope.cond.type);
                        $scope.$digest();
                    }
                }
            ]);
        </script>
    </body>
</html>